<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Prayer Recordings - Rosary73</title>
  <meta name="description" content="Upload your prayer recordings to participate in community rosaries">
  <link rel="icon" type="image/png" href="images/R73logo.png">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --sidebar-width: 280px;
      --header-height: 60px;
      --gold: #d4af37;
      --gold-dark: #b8860b;
      --bg-dark: #1a1a2e;
      --bg-darker: #16213e;
      --text-light: rgba(255,255,255,0.9);
      --text-muted: rgba(255,255,255,0.6);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
      min-height: 100vh;
      color: #ffffff;
    }
    
    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(26, 26, 46, 0.98);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 1000;
    }
    
    .header-left { display: flex; align-items: center; gap: 15px; }
    
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 5px;
      padding: 8px;
      cursor: pointer;
      background: none;
      border: none;
    }
    .hamburger span { width: 24px; height: 2px; background: white; transition: all 0.3s ease; }
    .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .hamburger.active span:nth-child(2) { opacity: 0; }
    .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
    
    .logo-link { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo { width: 36px; height: 36px; }
    .logo-text { color: var(--gold); font-size: 1.2rem; font-weight: 600; }
    
    .header-user { display: flex; align-items: center; gap: 15px; }
    .header-username { color: var(--gold); font-weight: 600; font-size: 0.95rem; }
    .header-logout {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    /* Sidebar */
    .sidebar {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background: rgba(22, 33, 62, 0.98);
      border-right: 1px solid rgba(255,255,255,0.1);
      overflow-y: auto;
      z-index: 900;
      transition: transform 0.3s ease;
    }
    
    .sidebar-section { margin-bottom: 20px; padding-top: 15px; }
    .sidebar-section-title {
      color: var(--text-muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0 20px 8px;
      font-weight: 600;
    }
    
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-light);
      text-decoration: none;
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .sidebar-item:hover { background: rgba(255,255,255,0.05); border-left-color: var(--gold); }
    .sidebar-item.active { background: rgba(212, 175, 55, 0.1); border-left-color: var(--gold); color: var(--gold); }
    .sidebar-item-icon { font-size: 1.1rem; width: 24px; text-align: center; }
    .sidebar-item-badge {
      background: var(--gold);
      color: var(--bg-dark);
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      margin-left: auto;
    }
    .sidebar-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 10px 20px; }
    .sidebar-item.danger { color: #f87171; }
    
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: var(--header-height);
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 850;
    }
    .sidebar-overlay.visible { display: block; }
    
    /* Main Content */
    .main-wrapper {
      margin-left: var(--sidebar-width);
      padding-top: var(--header-height);
      min-height: 100vh;
    }
    
    .main {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .page-title {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.8rem;
      color: var(--gold);
    }
    
    .page-subtitle {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 30px;
    }
    
    /* Login Gate */
    .login-gate {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      margin: 50px auto;
    }
    .login-gate h2 { color: var(--gold); margin-bottom: 15px; }
    .login-gate p { color: var(--text-muted); margin-bottom: 20px; }
    .login-form { display: flex; flex-direction: column; gap: 15px; }
    .login-form input {
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 1rem;
    }
    .login-form input::placeholder { color: rgba(255,255,255,0.4); }
    
    /* Instructions Card */
    .instructions-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 30px;
    }
    .instructions-card h3 { color: var(--gold); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .instructions-card ul { list-style: none; color: rgba(255,255,255,0.8); }
    .instructions-card li { padding: 8px 0; padding-left: 25px; position: relative; }
    .instructions-card li::before { content: "‚úì"; position: absolute; left: 0; color: #4ade80; }
    
    .language-note {
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .language-note .icon { font-size: 1.5rem; }
    .language-note p { color: rgba(255,255,255,0.9); font-size: 0.95rem; }
    
    .formats-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .format-badge {
      background: rgba(255,255,255,0.1);
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 0.85rem;
    }
    .format-badge strong { color: var(--gold); }
    
    /* Progress Overview */
    .progress-overview {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }
    .progress-text { font-size: 1.1rem; }
    .progress-text span { color: var(--gold); font-weight: 600; }
    .progress-bar-container {
      flex: 1;
      min-width: 200px;
      max-width: 300px;
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), #f0d875);
      border-radius: 5px;
      transition: width 0.3s ease;
    }
    
    /* Prayer Cards */
    .prayer-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    .prayer-card:hover { border-color: rgba(212, 175, 55, 0.3); }
    .prayer-card.uploaded { border-color: rgba(74, 222, 128, 0.3); background: rgba(74, 222, 128, 0.05); }
    
    .prayer-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    .prayer-info h4 { color: #ffffff; font-size: 1.1rem; margin-bottom: 5px; }
    .prayer-requirements { color: var(--text-muted); font-size: 0.85rem; }
    
    .prayer-status { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .status-pending { background: rgba(255,255,255,0.1); color: var(--text-muted); }
    .status-uploaded { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .status-error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    
    /* Upload Area */
    .upload-area {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover { border-color: var(--gold); background: rgba(212, 175, 55, 0.05); }
    .upload-area.dragover { border-color: var(--gold); background: rgba(212, 175, 55, 0.1); }
    .upload-icon { font-size: 2.5rem; margin-bottom: 10px; }
    .upload-text { color: rgba(255,255,255,0.7); margin-bottom: 5px; }
    .upload-hint { color: rgba(255,255,255,0.4); font-size: 0.85rem; }
    .file-input { display: none; }
    
    /* Audio Preview */
    .audio-preview { margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; }
    .audio-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .file-name { color: var(--gold); font-weight: 500; word-break: break-all; }
    .remove-file { background: rgba(239, 68, 68, 0.2); border: none; color: #f87171; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
    .audio-player { width: 100%; margin: 10px 0; }
    
    /* Audio Analysis */
    .audio-analysis { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
    .analysis-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; }
    .analysis-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 3px; }
    .analysis-value { font-weight: 600; font-size: 0.95rem; }
    .analysis-value.good { color: #4ade80; }
    .analysis-value.warning { color: #fbbf24; }
    .analysis-value.error { color: #f87171; }
    
    /* Warnings */
    .warning-box {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .warning-box.error { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
    .warning-icon { font-size: 1.2rem; }
    .warning-text { color: rgba(255,255,255,0.9); font-size: 0.9rem; }
    
    /* Trim Controls */
    .trim-controls { margin-top: 15px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 10px; }
    .trim-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .trim-header h5 { color: var(--gold); font-size: 0.9rem; }
    .trim-toggle { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; }
    .trim-toggle.active { background: var(--gold); color: var(--bg-dark); }
    .trim-sliders { display: none; }
    .trim-sliders.visible { display: block; }
    .trim-slider-group { margin-bottom: 10px; }
    .trim-slider-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; color: rgba(255,255,255,0.7); }
    .trim-slider { width: 100%; accent-color: var(--gold); }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      text-decoration: none;
    }
    .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--bg-dark); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #ffffff; border: 1px solid rgba(255,255,255,0.2); }
    .btn-small { padding: 8px 16px; font-size: 0.9rem; }
    
    /* Upload Actions */
    .upload-actions { display: flex; gap: 10px; margin-top: 15px; }
    .upload-btn { flex: 1; }
    
    /* Waveform */
    .waveform-container { height: 60px; background: rgba(0,0,0,0.3); border-radius: 8px; margin: 10px 0; position: relative; overflow: hidden; }
    .waveform-canvas { width: 100%; height: 100%; }
    .waveform-trim-overlay { position: absolute; top: 0; height: 100%; background: rgba(212, 175, 55, 0.2); pointer-events: none; }
    
    /* Toast Notifications */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    .toast {
      background: rgba(30, 30, 50, 0.95);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px 20px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }
    .toast.success { border-color: rgba(74, 222, 128, 0.3); }
    .toast.error { border-color: rgba(239, 68, 68, 0.3); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Loading Spinner */
    .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Footer */
    .footer { text-align: center; padding: 30px 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 50px; }
    .footer p { color: rgba(255,255,255,0.4); font-size: 0.85rem; }
    .footer a { color: var(--gold); text-decoration: none; }
    
    .hidden { display: none !important; }
    
    /* Mobile */
    @media (max-width: 900px) {
      .hamburger { display: flex; }
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main-wrapper { margin-left: 0; }
    }
    
    @media (max-width: 600px) {
      .prayer-header { flex-direction: column; gap: 10px; }
      .progress-overview { flex-direction: column; text-align: center; }
      .progress-bar-container { width: 100%; max-width: none; }
      .header-username { display: none; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="hamburger" id="hamburger" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
      </button>
      <a href="index.html" class="logo-link">
        <img src="images/R73logo.png" alt="Rosary73" class="logo">
        <span class="logo-text">Rosary73</span>
      </a>
    </div>
    <div class="header-user hidden" id="header-user">
      <span class="header-username" id="header-username">User</span>
      <button class="header-logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-section-title">Main</div>
      <a href="start-rosary.html" class="sidebar-item">
        <span class="sidebar-item-icon">‚úùÔ∏è</span>
        <span>Start a Rosary</span>
      </a>
      <a href="participate.html" class="sidebar-item">
        <span class="sidebar-item-icon">üôè</span>
        <span>Join Rosary</span>
      </a>
      <a href="finished.html" class="sidebar-item">
        <span class="sidebar-item-icon">üéß</span>
        <span>Finished Rosaries</span>
      </a>
      <a href="upload-prayers.html" class="sidebar-item active">
        <span class="sidebar-item-icon">üé§</span>
        <span>Upload Prayers</span>
        <span class="sidebar-item-badge" id="prayers-badge">0/7</span>
      </a>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">My Content</div>
      <a href="members.html" class="sidebar-item" onclick="sessionStorage.setItem('openSection','my-rosaries')">
        <span class="sidebar-item-icon">üìø</span>
        <span>My Rosaries</span>
      </a>
      <a href="members.html" class="sidebar-item" onclick="sessionStorage.setItem('openSection','my-groups')">
        <span class="sidebar-item-icon">üë•</span>
        <span>My Groups</span>
      </a>
    </div>

    <div class="sidebar-section" id="support-section">
      <div class="sidebar-section-title">Support Us</div>
      <a href="members.html" class="sidebar-item" id="subscribe-link" onclick="sessionStorage.setItem('openSection','subscribe')">
        <span class="sidebar-item-icon">‚≠ê</span>
        <span>Subscribe</span>
      </a>
      <a href="members.html" class="sidebar-item" onclick="sessionStorage.setItem('openSection','gift')">
        <span class="sidebar-item-icon">üéÅ</span>
        <span>Gift Subscription</span>
      </a>
      <a href="members.html" class="sidebar-item" onclick="sessionStorage.setItem('openSection','donate')">
        <span class="sidebar-item-icon">üíù</span>
        <span>Donate</span>
      </a>
    </div>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Account</div>
      <a href="members.html" class="sidebar-item" onclick="sessionStorage.setItem('openSection','settings')">
        <span class="sidebar-item-icon">‚öôÔ∏è</span>
        <span>Account Settings</span>
      </a>
    </div>

    <div class="sidebar-divider"></div>

    <button class="sidebar-item danger" onclick="logout()">
      <span class="sidebar-item-icon">üö™</span>
      <span>Logout</span>
    </button>
  </aside>

  <!-- Main Content -->
  <div class="main-wrapper" id="main-wrapper">
    <main class="main">
      <h1 class="page-title">üìø Upload Prayer Recordings</h1>
      <p class="page-subtitle">Record your prayers offline and upload them here</p>

      <!-- Login Gate -->
      <div id="login-gate" class="login-gate">
        <h2>üîê Sign In Required</h2>
        <p>Please sign in to upload your prayer recordings</p>
        <form class="login-form" id="login-form">
          <input type="text" id="login-username" placeholder="Username" required>
          <input type="password" id="login-password" placeholder="Password" required>
          <button type="submit" class="btn btn-primary">Sign In</button>
          <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 10px;">
            Don't have an account? <a href="signup.html" style="color: #d4af37;">Sign up here</a>
          </p>
        </form>
        <div id="login-error" class="warning-box error hidden" style="margin-top: 15px;">
          <span class="warning-icon">‚ùå</span>
          <span class="warning-text" id="login-error-text"></span>
        </div>
      </div>

      <!-- Main Content (hidden until logged in) -->
      <div id="main-content" class="hidden">
        <!-- Instructions -->
        <div class="instructions-card">
          <h3>üìã How to Record Your Prayers</h3>
          <ul>
            <li><strong>iPhone:</strong> Use Voice Memos app ‚Üí Record ‚Üí Share ‚Üí Save to Files</li>
            <li><strong>Android:</strong> Use Voice Recorder app ‚Üí Record ‚Üí Save to device</li>
            <li><strong>Mac:</strong> QuickTime Player ‚Üí File ‚Üí New Audio Recording</li>
            <li><strong>Windows:</strong> Voice Recorder app or Audacity (free)</li>
            <li>Find a <strong>quiet place</strong> with minimal background noise</li>
            <li>Hold your device <strong>6-12 inches</strong> from your mouth</li>
            <li>Speak <strong>clearly</strong> at a normal, reverent pace</li>
            <li>Listen back and <strong>re-record</strong> if needed before uploading</li>
          </ul>
          
          <div class="language-note">
            <span class="icon">üåç</span>
            <p><strong>Record in your own language!</strong> Rosary73 welcomes prayers in all languages. Whether you pray in English, Filipino, Spanish, Latin, or any other language, your recording will contribute to our global rosary community.</p>
          </div>
          
          <div class="formats-info">
            <div class="format-badge"><strong>M4A</strong> ‚úì Preferred</div>
            <div class="format-badge"><strong>MP3</strong> ‚úì Accepted</div>
            <div class="format-badge"><strong>WAV</strong> ‚úì Accepted</div>
            <div class="format-badge"><strong>WebM</strong> ‚úì Accepted</div>
            <div class="format-badge"><strong>Max size:</strong> 10MB</div>
          </div>
        </div>

        <!-- Progress Overview -->
        <div class="progress-overview">
          <div class="progress-text">
            Progress: <span id="progress-count">0</span> of 7 prayers uploaded
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
          </div>
        </div>

        <!-- Prayer Cards Container -->
        <div id="prayer-cards"></div>
      </div>
    </main>

    <footer class="footer">
      <p>Need help? <a href="contact.html">Contact Support</a> | <a href="index.html">Back to Home</a></p>
    </footer>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBzm-LuWZwyOCMqYzxodpqLNn4Eg3wNDk",
      authDomain: "rosary--interact-app.firebaseapp.com",
      projectId: "rosary--interact-app",
      storageBucket: "rosary--interact-app.firebasestorage.app",
      messagingSenderId: "174985016192",
      appId: "1:174985016192:web:134b684d6f0ba731510765"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    const FUNCTIONS_URL = 'https://us-central1-rosary--interact-app.cloudfunctions.net';

    const PRAYERS = [
      { id: 'creed', name: 'The Creed (Apostles\' Creed)', minDuration: 20, maxDuration: 55 },
      { id: 'ourFather', name: 'Our Father', minDuration: 12, maxDuration: 30 },
      { id: 'hailMary', name: 'Hail Mary', minDuration: 10, maxDuration: 27 },
      { id: 'gloryBe', name: 'Glory Be', minDuration: 5, maxDuration: 17 },
      { id: 'fatimaPrayer', name: 'Fatima Prayer (O My Jesus)', minDuration: 5, maxDuration: 20 },
      { id: 'hailHolyQueen', name: 'Hail Holy Queen', minDuration: 12, maxDuration: 41 },
      { id: 'finalPrayer', name: 'Final Prayer (Let Us Pray)', minDuration: 10, maxDuration: 35 }
    ];

    const ACCEPTED_EXTENSIONS = ['.m4a', '.mp3', '.wav', '.webm', '.ogg', '.mp4'];
    const MAX_FILE_SIZE = 10 * 1024 * 1024;

    let currentUser = null;
    let userData = null;
    let prayerStates = {};

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebar-overlay').classList.toggle('visible');
      document.getElementById('hamburger').classList.toggle('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeAuth();
      setupLoginForm();
    });

    function initializeAuth() {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await loadUserData();
          showMainContent();
        } else {
          currentUser = null;
          userData = null;
          showLoginGate();
        }
      });
    }

    async function loadUserData() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          userData = userDoc.data();
          document.getElementById('header-username').textContent = userData.username || userData.email;
          updateSidebarForUser();
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error loading user data', 'error');
      }
    }

    function updateSidebarForUser() {
      if (!userData) return;
      const recordings = userData.recordings || {};
      const prayerCount = Object.keys(recordings).filter(k => recordings[k]).length;
      document.getElementById('prayers-badge').textContent = `${prayerCount}/7`;
      
      const isPerpetual = userData.isPerpetual === true || userData.isAdmin === true || 
                          userData.hasSpecialAccess === true || userData.subscriptionStatus === 'perpetual';
      if (isPerpetual) {
        const subscribeLink = document.getElementById('subscribe-link');
        if (subscribeLink) {
          subscribeLink.innerHTML = '<span class="sidebar-item-icon">‚ú®</span><span>Perpetual Access</span>';
          subscribeLink.style.pointerEvents = 'none';
          subscribeLink.style.color = '#d4af37';
        }
      }
    }

    function setupLoginForm() {
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Signing in...';
        
        try {
          const response = await fetch(`${FUNCTIONS_URL}/verifyWebUser`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
          });
          
          const result = await response.json();
          if (!result.valid) throw new Error(result.error || 'Username not found');
          
          const emailToUse = result.email || `${username.toLowerCase()}@guest.r73.app`;
          await auth.signInWithEmailAndPassword(emailToUse, password);
          showToast('Signed in successfully!', 'success');
        } catch (error) {
          console.error('Login error:', error);
          document.getElementById('login-error').classList.remove('hidden');
          let errorMsg = error.message || 'Login failed';
          if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            errorMsg = 'Incorrect password.';
          }
          document.getElementById('login-error-text').textContent = errorMsg;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Sign In';
        }
      });
    }

    function logout() {
      auth.signOut();
      sessionStorage.removeItem('rosary73UserData');
      window.location.href = 'members.html';
    }

    function showLoginGate() {
      document.getElementById('login-gate').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('sidebar').style.display = 'none';
      document.getElementById('header-user').classList.add('hidden');
      document.getElementById('main-wrapper').style.marginLeft = '0';
    }

    function showMainContent() {
      document.getElementById('login-gate').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('sidebar').style.display = 'block';
      document.getElementById('header-user').classList.remove('hidden');
      if (window.innerWidth > 900) {
        document.getElementById('main-wrapper').style.marginLeft = 'var(--sidebar-width)';
      }
      renderPrayerCards();
      updateProgress();
    }

    function renderPrayerCards() {
      const container = document.getElementById('prayer-cards');
      container.innerHTML = '';
      
      PRAYERS.forEach((prayer, index) => {
        const existingRecording = userData?.recordings?.[prayer.id];
        prayerStates[prayer.id] = {
          file: null,
          audioData: null,
          analysis: null,
          trimStart: 0,
          trimEnd: 0,
          uploaded: !!existingRecording
        };
        
        const card = document.createElement('div');
        card.className = `prayer-card ${existingRecording ? 'uploaded' : ''}`;
        card.id = `prayer-card-${prayer.id}`;
        
        card.innerHTML = `
          <div class="prayer-header">
            <div class="prayer-info">
              <h4>${index + 1}. ${prayer.name}</h4>
              <div class="prayer-requirements">Duration: ${prayer.minDuration}-${prayer.maxDuration} seconds</div>
            </div>
            <span class="prayer-status ${existingRecording ? 'status-uploaded' : 'status-pending'}" id="status-${prayer.id}">
              ${existingRecording ? '‚úì Uploaded' : '‚óã Not uploaded'}
            </span>
          </div>
          
          <div class="upload-area" id="upload-area-${prayer.id}" onclick="triggerFileInput('${prayer.id}')">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">${existingRecording ? 'Click to replace recording' : 'Click to select file or drag & drop'}</div>
            <div class="upload-hint">M4A, MP3, WAV, WebM ‚Ä¢ Max 10MB</div>
          </div>
          <input type="file" class="file-input" id="file-input-${prayer.id}" accept="audio/*" onchange="handleFileSelect('${prayer.id}', event)">
          
          <div class="audio-preview hidden" id="preview-${prayer.id}"></div>
        `;
        
        container.appendChild(card);
        setupDragDrop(prayer.id);
      });
    }

    function triggerFileInput(prayerId) {
      document.getElementById(`file-input-${prayerId}`).click();
    }

    function setupDragDrop(prayerId) {
      const area = document.getElementById(`upload-area-${prayerId}`);
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); });
      });
      ['dragenter', 'dragover'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.add('dragover'));
      });
      ['dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.remove('dragover'));
      });
      area.addEventListener('drop', (e) => {
        const file = e.dataTransfer.files[0];
        if (file) processFile(prayerId, file);
      });
    }

    function handleFileSelect(prayerId, event) {
      const file = event.target.files[0];
      if (file) processFile(prayerId, file);
    }

    async function processFile(prayerId, file) {
      const prayer = PRAYERS.find(p => p.id === prayerId);
      const preview = document.getElementById(`preview-${prayerId}`);
      
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      if (!ACCEPTED_EXTENSIONS.includes(ext)) {
        showToast(`Invalid file format. Accepted: ${ACCEPTED_EXTENSIONS.join(', ')}`, 'error');
        return;
      }
      
      if (file.size > MAX_FILE_SIZE) {
        showToast('File too large. Maximum size is 10MB.', 'error');
        return;
      }
      
      preview.classList.remove('hidden');
      preview.innerHTML = `<div style="text-align: center; padding: 20px;"><div class="spinner" style="margin: 0 auto 10px;"></div><div>Analyzing audio...</div></div>`;
      
      try {
        const analysis = await analyzeAudio(file, prayer);
        prayerStates[prayerId].file = file;
        prayerStates[prayerId].analysis = analysis;
        prayerStates[prayerId].trimStart = analysis.silenceStart || 0;
        prayerStates[prayerId].trimEnd = analysis.silenceEnd || analysis.duration;
        renderAudioPreview(prayerId, file, analysis, prayer);
      } catch (error) {
        console.error('Error analyzing audio:', error);
        preview.innerHTML = `<div class="warning-box error"><span class="warning-icon">‚ùå</span><span class="warning-text">Error analyzing audio: ${error.message}</span></div>`;
      }
    }

    async function analyzeAudio(file, prayer) {
      return new Promise((resolve, reject) => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          try {
            const arrayBuffer = e.target.result;
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            const duration = audioBuffer.duration;
            const channelData = audioBuffer.getChannelData(0);
            
            let sumSquares = 0;
            let maxAmplitude = 0;
            const sampleRate = audioBuffer.sampleRate;
            
            for (let i = 0; i < channelData.length; i++) {
              const sample = Math.abs(channelData[i]);
              sumSquares += sample * sample;
              if (sample > maxAmplitude) maxAmplitude = sample;
            }
            
            const rms = Math.sqrt(sumSquares / channelData.length);
            const avgDb = 20 * Math.log10(rms + 0.0001);
            const peakDb = 20 * Math.log10(maxAmplitude + 0.0001);
            
            const silenceThreshold = 0.02;
            let silenceStart = 0;
            let silenceEnd = duration;
            
            for (let i = 0; i < channelData.length; i++) {
              if (Math.abs(channelData[i]) > silenceThreshold) {
                silenceStart = Math.max(0, (i / sampleRate) - 0.1);
                break;
              }
            }
            
            for (let i = channelData.length - 1; i >= 0; i--) {
              if (Math.abs(channelData[i]) > silenceThreshold) {
                silenceEnd = Math.min(duration, (i / sampleRate) + 0.1);
                break;
              }
            }
            
            const windowSize = Math.floor(sampleRate * 0.1);
            let noiseWindows = 0;
            let totalWindows = 0;
            
            for (let i = 0; i < channelData.length; i += windowSize) {
              let windowMax = 0;
              for (let j = i; j < Math.min(i + windowSize, channelData.length); j++) {
                windowMax = Math.max(windowMax, Math.abs(channelData[j]));
              }
              totalWindows++;
              if (windowMax > 0.01 && windowMax < 0.1) noiseWindows++;
            }
            
            const noiseRatio = noiseWindows / totalWindows;
            
            const waveformData = [];
            const samplesPerPixel = Math.floor(channelData.length / 200);
            for (let i = 0; i < 200; i++) {
              let max = 0;
              for (let j = 0; j < samplesPerPixel; j++) {
                const idx = i * samplesPerPixel + j;
                if (idx < channelData.length) max = Math.max(max, Math.abs(channelData[idx]));
              }
              waveformData.push(max);
            }
            
            resolve({
              duration, avgDb, peakDb, silenceStart, silenceEnd, noiseRatio, waveformData,
              durationValid: duration >= prayer.minDuration && duration <= prayer.maxDuration,
              trimmedDuration: silenceEnd - silenceStart,
              hasSilenceToTrim: silenceStart > 0.5 || (duration - silenceEnd) > 0.5
            });
          } catch (error) { reject(error); }
        };
        
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function renderAudioPreview(prayerId, file, analysis, prayer) {
      const preview = document.getElementById(`preview-${prayerId}`);
      const state = prayerStates[prayerId];
      
      let durationStatus = 'good', durationMessage = '';
      if (analysis.duration < prayer.minDuration) {
        durationStatus = 'error';
        durationMessage = `Too short! Minimum ${prayer.minDuration}s required.`;
      } else if (analysis.duration > prayer.maxDuration) {
        durationStatus = 'warning';
        durationMessage = `Longer than expected. Consider trimming to under ${prayer.maxDuration}s.`;
      }
      
      let volumeStatus = 'good', volumeMessage = '';
      if (analysis.avgDb < -35) { volumeStatus = 'error'; volumeMessage = 'Recording is too quiet. Please record closer to the microphone.'; }
      else if (analysis.avgDb < -25) { volumeStatus = 'warning'; volumeMessage = 'Recording volume is low. Consider recording louder.'; }
      else if (analysis.peakDb > -3) { volumeStatus = 'warning'; volumeMessage = 'Some parts may be distorted. Consider recording at lower volume.'; }
      
      let noiseStatus = 'good', noiseMessage = '';
      if (analysis.noiseRatio > 0.4) { noiseStatus = 'warning'; noiseMessage = 'Background noise detected. Consider recording in a quieter environment.'; }
      
      const canUpload = analysis.duration >= prayer.minDuration;
      
      preview.innerHTML = `
        <div class="audio-preview-header">
          <span class="file-name">üìÑ ${file.name}</span>
          <button class="remove-file" onclick="removeFile('${prayerId}')">‚úï Remove</button>
        </div>
        <div class="waveform-container">
          <canvas class="waveform-canvas" id="waveform-${prayerId}"></canvas>
          <div class="waveform-trim-overlay" id="trim-overlay-${prayerId}"></div>
        </div>
        <audio controls class="audio-player" id="audio-player-${prayerId}">
          <source src="${URL.createObjectURL(file)}" type="${file.type}">
        </audio>
        <div class="audio-analysis">
          <div class="analysis-item"><div class="analysis-label">Duration</div><div class="analysis-value ${durationStatus}">${analysis.duration.toFixed(1)}s</div></div>
          <div class="analysis-item"><div class="analysis-label">Required</div><div class="analysis-value">${prayer.minDuration}-${prayer.maxDuration}s</div></div>
          <div class="analysis-item"><div class="analysis-label">Volume</div><div class="analysis-value ${volumeStatus}">${analysis.avgDb > -25 ? 'Good' : analysis.avgDb > -35 ? 'Low' : 'Too Quiet'}</div></div>
          <div class="analysis-item"><div class="analysis-label">Quality</div><div class="analysis-value ${noiseStatus}">${analysis.noiseRatio < 0.3 ? 'Good' : 'Noisy'}</div></div>
        </div>
        ${durationMessage ? `<div class="warning-box ${durationStatus === 'error' ? 'error' : ''}"><span class="warning-icon">${durationStatus === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span><span class="warning-text">${durationMessage}</span></div>` : ''}
        ${volumeMessage ? `<div class="warning-box ${volumeStatus === 'error' ? 'error' : ''}"><span class="warning-icon">${volumeStatus === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span><span class="warning-text">${volumeMessage}</span></div>` : ''}
        ${noiseMessage ? `<div class="warning-box"><span class="warning-icon">‚ö†Ô∏è</span><span class="warning-text">${noiseMessage}</span></div>` : ''}
        ${analysis.hasSilenceToTrim ? `
        <div class="trim-controls">
          <div class="trim-header">
            <h5>‚úÇÔ∏è Trim Silence</h5>
            <button class="trim-toggle" id="trim-toggle-${prayerId}" onclick="toggleTrim('${prayerId}')">Auto-trim: OFF</button>
          </div>
          <div class="trim-sliders" id="trim-sliders-${prayerId}">
            <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 10px;">
              Detected ${analysis.silenceStart.toFixed(1)}s silence at start, ${(analysis.duration - analysis.silenceEnd).toFixed(1)}s at end
            </p>
            <div class="trim-slider-group">
              <div class="trim-slider-label"><span>Start trim</span><span id="trim-start-value-${prayerId}">${analysis.silenceStart.toFixed(1)}s</span></div>
              <input type="range" class="trim-slider" id="trim-start-${prayerId}" min="0" max="${analysis.duration}" step="0.1" value="${analysis.silenceStart}" onchange="updateTrim('${prayerId}')">
            </div>
            <div class="trim-slider-group">
              <div class="trim-slider-label"><span>End trim</span><span id="trim-end-value-${prayerId}">${analysis.silenceEnd.toFixed(1)}s</span></div>
              <input type="range" class="trim-slider" id="trim-end-${prayerId}" min="0" max="${analysis.duration}" step="0.1" value="${analysis.silenceEnd}" onchange="updateTrim('${prayerId}')">
            </div>
            <p style="font-size: 0.85rem; color: #d4af37; margin-top: 5px;">Trimmed duration: <span id="trimmed-duration-${prayerId}">${(analysis.silenceEnd - analysis.silenceStart).toFixed(1)}</span>s</p>
          </div>
        </div>
        ` : ''}
        <div class="upload-actions">
          <button class="btn btn-primary upload-btn" onclick="uploadPrayer('${prayerId}')" ${!canUpload ? 'disabled' : ''}>üì§ Upload Recording</button>
        </div>
      `;
      
      drawWaveform(prayerId, analysis.waveformData);
    }

    function drawWaveform(prayerId, waveformData) {
      const canvas = document.getElementById(`waveform-${prayerId}`);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      const width = rect.width;
      const height = rect.height;
      const barWidth = width / waveformData.length;
      const centerY = height / 2;
      
      ctx.fillStyle = '#d4af37';
      waveformData.forEach((value, i) => {
        const barHeight = value * height * 0.8;
        ctx.fillRect(i * barWidth, centerY - barHeight / 2, barWidth - 1, barHeight);
      });
    }

    function toggleTrim(prayerId) {
      const toggle = document.getElementById(`trim-toggle-${prayerId}`);
      const sliders = document.getElementById(`trim-sliders-${prayerId}`);
      const state = prayerStates[prayerId];
      
      state.trimEnabled = !state.trimEnabled;
      
      if (state.trimEnabled) {
        toggle.textContent = 'Auto-trim: ON';
        toggle.classList.add('active');
        sliders.classList.add('visible');
      } else {
        toggle.textContent = 'Auto-trim: OFF';
        toggle.classList.remove('active');
        sliders.classList.remove('visible');
        state.trimStart = 0;
        state.trimEnd = state.analysis.duration;
      }
    }

    function updateTrim(prayerId) {
      const state = prayerStates[prayerId];
      const startSlider = document.getElementById(`trim-start-${prayerId}`);
      const endSlider = document.getElementById(`trim-end-${prayerId}`);
      
      state.trimStart = parseFloat(startSlider.value);
      state.trimEnd = parseFloat(endSlider.value);
      
      document.getElementById(`trim-start-value-${prayerId}`).textContent = state.trimStart.toFixed(1) + 's';
      document.getElementById(`trim-end-value-${prayerId}`).textContent = state.trimEnd.toFixed(1) + 's';
      document.getElementById(`trimmed-duration-${prayerId}`).textContent = (state.trimEnd - state.trimStart).toFixed(1);
      
      const overlay = document.getElementById(`trim-overlay-${prayerId}`);
      const duration = state.analysis.duration;
      overlay.style.left = (state.trimStart / duration * 100) + '%';
      overlay.style.width = ((state.trimEnd - state.trimStart) / duration * 100) + '%';
    }

    function removeFile(prayerId) {
      const state = prayerStates[prayerId];
      state.file = null;
      state.analysis = null;
      document.getElementById(`preview-${prayerId}`).classList.add('hidden');
      document.getElementById(`preview-${prayerId}`).innerHTML = '';
      document.getElementById(`file-input-${prayerId}`).value = '';
    }

    async function uploadPrayer(prayerId) {
      const state = prayerStates[prayerId];
      const prayer = PRAYERS.find(p => p.id === prayerId);
      
      if (!state.file) { showToast('No file selected', 'error'); return; }
      
      const preview = document.getElementById(`preview-${prayerId}`);
      const uploadBtn = preview.querySelector('.upload-btn');
      
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<span class="spinner"></span> Uploading...';
      
      try {
        let fileToUpload = state.file;
        
        if (state.trimEnabled && (state.trimStart > 0 || state.trimEnd < state.analysis.duration)) {
          fileToUpload = await trimAudio(state.file, state.trimStart, state.trimEnd);
        }
        
        const extension = state.file.name.split('.').pop().toLowerCase();
        const storagePath = `users/${currentUser.uid}/prayers/${prayerId}.${extension === 'webm' ? 'm4a' : extension}`;
        const storageRef = storage.ref(storagePath);
        
        await storageRef.put(fileToUpload);
        const downloadUrl = await storageRef.getDownloadURL();
        
        await db.collection('users').doc(currentUser.uid).update({
          [`recordings.${prayerId}`]: downloadUrl
        });
        
        state.uploaded = true;
        userData.recordings = userData.recordings || {};
        userData.recordings[prayerId] = downloadUrl;
        
        const card = document.getElementById(`prayer-card-${prayerId}`);
        card.classList.add('uploaded');
        document.getElementById(`status-${prayerId}`).textContent = '‚úì Uploaded';
        document.getElementById(`status-${prayerId}`).className = 'prayer-status status-uploaded';
        
        updateProgress();
        updateSidebarForUser();
        showToast(`${prayer.name} uploaded successfully!`, 'success');
        
        preview.innerHTML = `<div style="text-align: center; padding: 20px; color: #4ade80;">‚úÖ Recording uploaded successfully!<br><small style="color: rgba(255,255,255,0.6);">Click the upload area above to replace this recording</small></div>`;
      } catch (error) {
        console.error('Upload error:', error);
        showToast('Upload failed: ' + error.message, 'error');
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'üì§ Upload Recording';
      }
    }

    async function trimAudio(file, startTime, endTime) {
      return new Promise((resolve, reject) => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          try {
            const arrayBuffer = e.target.result;
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            const sampleRate = audioBuffer.sampleRate;
            const startSample = Math.floor(startTime * sampleRate);
            const endSample = Math.floor(endTime * sampleRate);
            const newLength = endSample - startSample;
            
            const newBuffer = audioContext.createBuffer(audioBuffer.numberOfChannels, newLength, sampleRate);
            
            for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
              const oldData = audioBuffer.getChannelData(channel);
              const newData = newBuffer.getChannelData(channel);
              for (let i = 0; i < newLength; i++) newData[i] = oldData[startSample + i];
            }
            
            const wavBlob = audioBufferToWav(newBuffer);
            resolve(wavBlob);
          } catch (error) { reject(error); }
        };
        
        reader.onerror = () => reject(new Error('Failed to read file for trimming'));
        reader.readAsArrayBuffer(file);
      });
    }

    function audioBufferToWav(buffer) {
      const numChannels = buffer.numberOfChannels;
      const sampleRate = buffer.sampleRate;
      const format = 1;
      const bitDepth = 16;
      const bytesPerSample = bitDepth / 8;
      const blockAlign = numChannels * bytesPerSample;
      const dataLength = buffer.length * blockAlign;
      const bufferLength = 44 + dataLength;
      const arrayBuffer = new ArrayBuffer(bufferLength);
      const view = new DataView(arrayBuffer);
      
      writeString(view, 0, 'RIFF');
      view.setUint32(4, bufferLength - 8, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, format, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * blockAlign, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitDepth, true);
      writeString(view, 36, 'data');
      view.setUint32(40, dataLength, true);
      
      const offset = 44;
      const channelData = [];
      for (let i = 0; i < numChannels; i++) channelData.push(buffer.getChannelData(i));
      
      let pos = 0;
      for (let i = 0; i < buffer.length; i++) {
        for (let channel = 0; channel < numChannels; channel++) {
          let sample = channelData[channel][i];
          sample = Math.max(-1, Math.min(1, sample));
          sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
          view.setInt16(offset + pos, sample, true);
          pos += 2;
        }
      }
      
      return new Blob([arrayBuffer], { type: 'audio/wav' });
    }

    function writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
    }

    function updateProgress() {
      const uploaded = PRAYERS.filter(p => prayerStates[p.id]?.uploaded).length;
      document.getElementById('progress-count').textContent = uploaded;
      document.getElementById('progress-bar').style.width = (uploaded / 7 * 100) + '%';
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${message}</span>`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    window.addEventListener('resize', () => {
      if (window.innerWidth > 900 && userData) {
        document.getElementById('main-wrapper').style.marginLeft = 'var(--sidebar-width)';
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').classList.remove('visible');
        document.getElementById('hamburger').classList.remove('active');
      } else if (userData) {
        document.getElementById('main-wrapper').style.marginLeft = '0';
      }
    });
  </script>
</body>
</html>
