<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscribe - Rosary73</title>
  <meta name="description" content="Subscribe to Rosary73 and unlock all premium features">
  <link rel="icon" type="image/png" href="images/R73logo.png">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%); min-height: 100vh; }
    .header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo-link { display: inline-flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo { width: 50px; height: 50px; }
    .logo-text { color: #d4af37; font-size: 1.5rem; font-weight: 600; }
    .main { padding: 40px 20px; max-width: 900px; margin: 0 auto; }
    h1 { color: #ffffff; font-size: 2rem; text-align: center; margin-bottom: 10px; }
    .subtitle { color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 30px; }
    
    /* Login Section */
    .login-section { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; margin-bottom: 30px; }
    .login-section h2 { color: #d4af37; font-size: 1.2rem; margin-bottom: 15px; }
    .login-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .login-row input { flex: 1; min-width: 200px; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 1rem; }
    .login-row input:focus { outline: none; border-color: #d4af37; }
    .login-row input::placeholder { color: rgba(255,255,255,0.4); }
    .login-row button { padding: 12px 24px; background: linear-gradient(135deg, #d4af37, #b8860b); border: none; border-radius: 8px; color: #1a1a2e; font-weight: 600; cursor: pointer; }
    .login-row button:hover { transform: translateY(-1px); }
    .login-row button:disabled { opacity: 0.6; cursor: not-allowed; }
    .user-info { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .user-badge { background: rgba(34, 197, 94, 0.2); border: 1px solid #4ade80; padding: 8px 16px; border-radius: 20px; color: #86efac; }
    .logout-btn { background: none; border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px; color: rgba(255,255,255,0.7); cursor: pointer; }
    .status-msg { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 0.9rem; }
    .status-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; }
    .status-success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #86efac; }
    .hidden { display: none; }
    
    /* Region Toggle */
    .region-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
    .region-btn { padding: 10px 20px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 25px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.3s; }
    .region-btn.active { background: rgba(212, 175, 55, 0.2); border-color: #d4af37; color: #d4af37; }
    
    /* Pricing Cards */
    .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .price-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; }
    .price-card:hover { border-color: rgba(212, 175, 55, 0.5); transform: translateY(-3px); }
    .price-card.selected { border-color: #d4af37; background: rgba(212, 175, 55, 0.1); }
    .price-card .badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #d4af37; color: #1a1a2e; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .price-card .duration { color: #d4af37; font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; }
    .price-card .price { color: #ffffff; font-size: 2.5rem; font-weight: 700; }
    .price-card .price small { font-size: 1rem; color: rgba(255,255,255,0.6); }
    .price-card .savings { color: #4ade80; font-size: 0.85rem; margin-top: 8px; }
    
    /* Payment Methods */
    .payment-section { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; }
    .payment-section h2 { color: #ffffff; font-size: 1.2rem; margin-bottom: 20px; text-align: center; }
    .payment-group { margin-bottom: 20px; }
    .payment-group-title { color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .web-only-tag { background: #4ade80; color: #1a1a2e; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .payment-methods { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
    .payment-btn { padding: 15px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    .payment-btn:hover { border-color: rgba(212, 175, 55, 0.5); }
    .payment-btn.selected { border-color: #d4af37; background: rgba(212, 175, 55, 0.1); }
    .payment-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .payment-btn .icon { font-size: 1.5rem; }
    .payment-btn .name { font-size: 0.85rem; }
    
    /* Subscribe Button */
    .subscribe-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #d4af37, #b8860b); border: none; border-radius: 12px; color: #1a1a2e; font-size: 1.2rem; font-weight: 700; cursor: pointer; margin-top: 25px; transition: all 0.3s; }
    .subscribe-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3); }
    .subscribe-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    /* Processing Overlay */
    .processing-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .processing-content { text-align: center; color: #fff; }
    .processing-spinner { width: 50px; height: 50px; border: 4px solid rgba(212, 175, 55, 0.3); border-top-color: #d4af37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .footer { padding: 30px 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }
    .footer p { color: rgba(255,255,255,0.4); font-size: 0.85rem; }
    .footer a { color: #d4af37; text-decoration: none; }
  </style>
</head>
<body>
  <header class="header">
    <a href="index.html" class="logo-link">
      <img src="images/R73logo.png" alt="Rosary73" class="logo">
      <span class="logo-text">Rosary73</span>
    </a>
  </header>

  <main class="main">
    <h1>Choose Your Plan</h1>
    <p class="subtitle">Unlock all features and pray with the global community</p>

    <!-- Login Section -->
    <div class="login-section">
      <div id="login-form">
        <h2>Step 1: Enter Your Username</h2>
        <div class="login-row">
          <input type="text" id="username-input" placeholder="Your username" autocomplete="username">
          <button onclick="verifyUser()" id="verify-btn">Continue</button>
        </div>
        <div id="login-status" class="status-msg hidden"></div>
        <p style="margin-top: 15px; color: rgba(255,255,255,0.5); font-size: 0.85rem;">
          Don't have an account? <a href="signup.html" style="color: #d4af37;">Sign up first</a>
        </p>
      </div>
      
      <div id="user-logged-in" class="hidden">
        <div class="user-info">
          <span class="user-badge">üë§ <span id="logged-username"></span></span>
          <span style="color: rgba(255,255,255,0.6);" id="subscription-status"></span>
          <button class="logout-btn" onclick="logout()">Change User</button>
        </div>
      </div>
    </div>

    <!-- Region Toggle -->
    <div class="region-toggle">
      <button class="region-btn active" data-region="PH" onclick="setRegion('PH')">üáµüá≠ Philippines</button>
      <button class="region-btn" data-region="OTHER" onclick="setRegion('OTHER')">üåç Other Countries</button>
    </div>

    <!-- Pricing Cards -->
    <div class="pricing-grid">
      <div class="price-card" data-plan="threeMonth" onclick="selectPlan('threeMonth')">
        <div class="duration">3 Months</div>
        <div class="price" id="price-3">‚Ç±99</div>
      </div>
      <div class="price-card selected" data-plan="sixMonth" onclick="selectPlan('sixMonth')">
        <div class="badge">MOST POPULAR</div>
        <div class="duration">6 Months</div>
        <div class="price" id="price-6">‚Ç±179</div>
        <div class="savings">Save 10%</div>
      </div>
      <div class="price-card" data-plan="twelveMonth" onclick="selectPlan('twelveMonth')">
        <div class="badge">BEST VALUE</div>
        <div class="duration">12 Months</div>
        <div class="price" id="price-12">‚Ç±329</div>
        <div class="savings">Save 17%</div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="payment-section" id="payment-section">
      <h2>Step 2: Choose Payment Method</h2>
      
      <div class="payment-group" id="ewallet-group">
        <div class="payment-group-title">
          <span>eWallets</span>
          <span class="web-only-tag">WEB ONLY</span>
        </div>
        <div class="payment-methods">
          <button class="payment-btn" data-method="gcash" onclick="selectPayment('gcash')">
            <span class="icon">üíô</span>
            <span class="name">GCash</span>
          </button>
          <button class="payment-btn" data-method="maya" onclick="selectPayment('maya')">
            <span class="icon">üíö</span>
            <span class="name">Maya</span>
          </button>
          <button class="payment-btn" data-method="grabpay" onclick="selectPayment('grabpay')">
            <span class="icon">üíö</span>
            <span class="name">GrabPay</span>
          </button>
          <button class="payment-btn" data-method="shopeepay" onclick="selectPayment('shopeepay')">
            <span class="icon">üß°</span>
            <span class="name">ShopeePay</span>
          </button>
        </div>
      </div>
      
      <div class="payment-group" id="qrph-group">
        <div class="payment-group-title">
          <span>QR PH (InstaPay/PESONet)</span>
          <span class="web-only-tag">WEB ONLY</span>
        </div>
        <div class="payment-methods">
          <button class="payment-btn" data-method="qrph" onclick="selectPayment('qrph')">
            <span class="icon">üì±</span>
            <span class="name">QR PH</span>
          </button>
        </div>
      </div>
      
      <div class="payment-group">
        <div class="payment-group-title">Credit/Debit Card</div>
        <div class="payment-methods">
          <button class="payment-btn" data-method="card" onclick="selectPayment('card')">
            <span class="icon">üí≥</span>
            <span class="name">Card</span>
          </button>
        </div>
      </div>

      <button class="subscribe-btn" id="subscribe-btn" onclick="subscribe()" disabled>
        Select a payment method
      </button>
    </div>
  </main>

  <!-- Processing Overlay -->
  <div class="processing-overlay hidden" id="processing-overlay">
    <div class="processing-content">
      <div class="processing-spinner"></div>
      <p>Redirecting to payment...</p>
    </div>
  </div>

  <footer class="footer">
    <p>Secure payments powered by Xendit</p>
    <p style="margin-top: 10px;"><a href="terms.html">Terms</a> ¬∑ <a href="privacy.html">Privacy</a> ¬∑ <a href="contact.html">Support</a></p>
  </footer>

  <script>
    const FUNCTIONS_URL = 'https://us-central1-rosary73-6e8a4.cloudfunctions.net';
    
    let currentUser = null;
    let selectedPlan = 'sixMonth';
    let selectedPayment = null;
    let currentRegion = 'PH';
    
    const PRICING = {
      PH: { threeMonth: 99, sixMonth: 179, twelveMonth: 329, currency: 'PHP', symbol: '‚Ç±' },
      OTHER: { threeMonth: 2.99, sixMonth: 5.49, twelveMonth: 9.90, currency: 'USD', symbol: '$' }
    };

    function init() {
      const saved = sessionStorage.getItem('rosary73User');
      if (saved) {
        currentUser = JSON.parse(saved);
        showLoggedIn();
      }
      updatePricing();
    }

    async function verifyUser() {
      const username = document.getElementById('username-input').value.trim();
      if (!username) return;
      
      const btn = document.getElementById('verify-btn');
      const status = document.getElementById('login-status');
      btn.disabled = true;
      btn.textContent = 'Checking...';
      
      try {
        const response = await fetch(`${FUNCTIONS_URL}/verifyWebUser`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          status.className = 'status-msg status-error';
          status.textContent = result.error;
          status.classList.remove('hidden');
          
          if (result.requiresVerification) {
            status.innerHTML = result.error + ' <a href="verify-email.html" style="color:#d4af37;">Verify now</a>';
          }
          return;
        }
        
        currentUser = result;
        sessionStorage.setItem('rosary73User', JSON.stringify(result));
        
        if (result.regionCode) {
          setRegion(result.regionCode);
        }
        
        showLoggedIn();
        
      } catch (error) {
        status.className = 'status-msg status-error';
        status.textContent = 'Connection error. Please try again.';
        status.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Continue';
      }
    }

    function showLoggedIn() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('user-logged-in').classList.remove('hidden');
      document.getElementById('logged-username').textContent = currentUser.username;
      
      const statusText = currentUser.subscriptionStatus === 'active' ? '‚úÖ Active Subscriber' : 
                         currentUser.subscriptionStatus === 'trial' ? '‚è≥ Free Trial' : '‚ö†Ô∏è Expired';
      document.getElementById('subscription-status').textContent = statusText;
    }

    function logout() {
      currentUser = null;
      sessionStorage.removeItem('rosary73User');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('user-logged-in').classList.add('hidden');
      document.getElementById('login-status').classList.add('hidden');
      document.getElementById('username-input').value = '';
    }

    function setRegion(region) {
      currentRegion = region;
      document.querySelectorAll('.region-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.region === region);
      });
      
      const isPH = region === 'PH';
      document.getElementById('ewallet-group').style.display = isPH ? 'block' : 'none';
      document.getElementById('qrph-group').style.display = isPH ? 'block' : 'none';
      
      if (!isPH && ['gcash', 'maya', 'grabpay', 'shopeepay', 'qrph'].includes(selectedPayment)) {
        selectedPayment = null;
        document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('selected'));
        updateSubscribeButton();
      }
      
      updatePricing();
    }

    function updatePricing() {
      const p = PRICING[currentRegion];
      document.getElementById('price-3').innerHTML = `${p.symbol}${p.threeMonth}`;
      document.getElementById('price-6').innerHTML = `${p.symbol}${p.sixMonth}`;
      document.getElementById('price-12').innerHTML = `${p.symbol}${p.twelveMonth}`;
    }

    function selectPlan(plan) {
      selectedPlan = plan;
      document.querySelectorAll('.price-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.plan === plan);
      });
      updateSubscribeButton();
    }

    function selectPayment(method) {
      selectedPayment = method;
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.method === method);
      });
      updateSubscribeButton();
    }

    function updateSubscribeButton() {
      const btn = document.getElementById('subscribe-btn');
      if (!currentUser) {
        btn.textContent = 'Enter username first';
        btn.disabled = true;
      } else if (!selectedPayment) {
        btn.textContent = 'Select a payment method';
        btn.disabled = true;
      } else {
        const p = PRICING[currentRegion];
        const amount = p[selectedPlan];
        btn.textContent = `Subscribe for ${p.symbol}${amount}`;
        btn.disabled = false;
      }
    }

    async function subscribe() {
      if (!currentUser || !selectedPayment) return;
      
      const overlay = document.getElementById('processing-overlay');
      overlay.classList.remove('hidden');
      
      try {
        const p = PRICING[currentRegion];
        const amount = p[selectedPlan];
        
        const response = await fetch(`${FUNCTIONS_URL}/createXenditPayment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'subscription',
            userId: currentUser.userId,
            plan: selectedPlan,
            amount: amount,
            currency: p.currency,
            paymentMethod: selectedPayment,
            source: 'website',
            successUrl: 'https://rosary73.com/payment-success.html',
            failureUrl: 'https://rosary73.com/payment-failed.html'
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error);
        
        if (result.paymentUrl) {
          window.location.href = result.paymentUrl;
        } else if (result.deepLinkUrl) {
          window.location.href = result.deepLinkUrl;
        } else {
          throw new Error('No payment URL received');
        }
        
      } catch (error) {
        overlay.classList.add('hidden');
        alert('Payment error: ' + error.message);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
    document.getElementById('username-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') verifyUser();
    });
  </script>
</body>
</html>
