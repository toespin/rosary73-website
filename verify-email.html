<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Email - Rosary73</title>
  <meta name="description" content="Verify your email to complete Rosary73 registration">
  <link rel="icon" type="image/png" href="images/R73logo.png">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%); min-height: 100vh; display: flex; flex-direction: column; }
    .header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo-link { display: inline-flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo { width: 50px; height: 50px; }
    .logo-text { color: #d4af37; font-size: 1.5rem; font-weight: 600; }
    .main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
    .verify-container { width: 100%; max-width: 500px; text-align: center; }
    .icon-large { font-size: 4rem; margin-bottom: 20px; }
    .verify-container h1 { color: #ffffff; font-size: 2rem; margin-bottom: 15px; }
    .verify-container p { color: rgba(255,255,255,0.7); margin-bottom: 10px; line-height: 1.6; }
    .email-highlight { color: #d4af37; font-weight: 600; }
    .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; margin-top: 30px; }
    .checklist { text-align: left; margin: 20px 0; }
    .checklist-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px; color: rgba(255,255,255,0.8); }
    .checklist-item .num { background: #d4af37; color: #1a1a2e; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; flex-shrink: 0; }
    .btn { display: inline-block; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; border: none; }
    .btn-primary { background: linear-gradient(135deg, #d4af37, #b8860b); color: #1a1a2e; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3); }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #ffffff; border: 1px solid rgba(255,255,255,0.2); margin-left: 10px; }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
    .buttons { margin-top: 25px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
    .success-card { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); }
    .success-card h1 { color: #86efac; }
    .error-card { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
    .error-card h1 { color: #fca5a5; }
    .next-steps { text-align: left; margin-top: 20px; }
    .next-steps h3 { color: #d4af37; margin-bottom: 15px; }
    .next-steps li { color: rgba(255,255,255,0.8); margin-bottom: 10px; padding-left: 5px; }
    .status-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; }
    .status-checking { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #93c5fd; }
    .status-success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #86efac; }
    .status-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; }
    .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .footer { padding: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }
    .footer p { color: rgba(255,255,255,0.4); font-size: 0.85rem; }
    .footer a { color: #d4af37; text-decoration: none; }
  </style>
</head>
<body>
  <header class="header">
    <a href="index.html" class="logo-link">
      <img src="images/R73logo.png" alt="Rosary73" class="logo">
      <span class="logo-text">Rosary73</span>
    </a>
  </header>

  <main class="main">
    <div class="verify-container">
      <!-- Pending Verification State -->
      <div id="pending-state">
        <div class="icon-large">üìß</div>
        <h1>Check Your Email</h1>
        <p>We've sent a verification link to:</p>
        <p class="email-highlight" id="display-email">your@email.com</p>
        
        <div class="card">
          <div class="checklist">
            <div class="checklist-item"><span class="num">1</span><span>Open your email inbox</span></div>
            <div class="checklist-item"><span class="num">2</span><span>Look for email from "R73 Interactive Rosary"</span></div>
            <div class="checklist-item"><span class="num">3</span><span>Click the verification link</span></div>
            <div class="checklist-item"><span class="num">4</span><span>Return here and click "I've Verified"</span></div>
          </div>
          
          <div id="status-message" class="status-message hidden"></div>
          
          <div class="buttons">
            <button class="btn btn-primary" onclick="checkVerification()">I've Verified My Email</button>
            <button class="btn btn-secondary" id="resend-btn" onclick="resendEmail()">Resend Email</button>
          </div>
          
          <p style="margin-top: 20px; font-size: 0.85rem; color: rgba(255,255,255,0.5);">
            Don't see it? Check your spam folder.
          </p>
        </div>
      </div>

      <!-- Success State -->
      <div id="success-state" class="hidden">
        <div class="icon-large">‚úÖ</div>
        <h1 style="color: #86efac;">Email Verified!</h1>
        <p>Your account is now active. You have a 7-day free trial.</p>
        
        <div class="card success-card">
          <div class="next-steps">
            <h3>What's Next?</h3>
            <ol>
              <li><strong>Download the app</strong> to record your prayers</li>
              <li><strong>Login</strong> with your username and password</li>
              <li><strong>Record your 7 prayers</strong> to start participating</li>
              <li><strong>Subscribe</strong> to unlock all features</li>
            </ol>
          </div>
          
          <div class="buttons">
            <a href="index.html#download" class="btn btn-primary">Download the App</a>
            <a href="subscribe.html" class="btn btn-secondary">Subscribe Now</a>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden">
        <div class="icon-large">‚ùå</div>
        <h1 style="color: #fca5a5;">Verification Failed</h1>
        <p id="error-message">Something went wrong. Please try again.</p>
        
        <div class="card error-card">
          <div class="buttons">
            <button class="btn btn-primary" onclick="resendEmail()">Resend Verification Email</button>
            <a href="signup.html" class="btn btn-secondary">Back to Signup</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>Need help? <a href="contact.html">Contact Support</a></p>
  </footer>

  <script>
    // CORRECT Cloud Functions URL
    const FUNCTIONS_URL = 'https://us-central1-rosary--interact-app.cloudfunctions.net';
    let userEmail = '';
    let userId = '';
    let resendCooldown = 0;

    function init() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Check for success redirect
      if (urlParams.get('success') === 'true') {
        showSuccess();
        return;
      }
      
      // Check for error
      const error = urlParams.get('error');
      if (error) {
        showError(error === 'invalid' ? 'Invalid verification link.' : error === 'expired' ? 'Verification link has expired.' : 'Verification failed.');
        return;
      }
      
      // Get email from URL or sessionStorage
      userEmail = urlParams.get('email') || '';
      const pending = sessionStorage.getItem('pendingVerification');
      
      if (pending) {
        const data = JSON.parse(pending);
        userEmail = userEmail || data.email;
        userId = data.userId;
      }
      
      if (userEmail) {
        document.getElementById('display-email').textContent = userEmail;
      }
      
      // Start polling for verification
      startPolling();
    }

    let pollInterval;
    function startPolling() {
      pollInterval = setInterval(async () => {
        if (userEmail) {
          try {
            const response = await fetch(`${FUNCTIONS_URL}/checkEmailVerification`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: userEmail })
            });
            const result = await response.json();
            if (result.verified) {
              clearInterval(pollInterval);
              showSuccess();
            }
          } catch (e) { /* ignore polling errors */ }
        }
      }, 5000);
    }

    async function checkVerification() {
      const statusDiv = document.getElementById('status-message');
      statusDiv.className = 'status-message status-checking';
      statusDiv.innerHTML = '<span class="spinner"></span> Checking verification status...';
      statusDiv.classList.remove('hidden');

      try {
        const response = await fetch(`${FUNCTIONS_URL}/checkEmailVerification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail, userId: userId })
        });

        const result = await response.json();

        if (result.verified) {
          showSuccess();
        } else {
          statusDiv.className = 'status-message status-error';
          statusDiv.textContent = 'Email not verified yet. Please click the link in your email first.';
        }
      } catch (error) {
        statusDiv.className = 'status-message status-error';
        statusDiv.textContent = 'Error checking status. Please try again.';
      }
    }

    async function resendEmail() {
      if (resendCooldown > 0) return;
      
      const btn = document.getElementById('resend-btn');
      const statusDiv = document.getElementById('status-message');
      
      btn.disabled = true;
      statusDiv.className = 'status-message status-checking';
      statusDiv.innerHTML = '<span class="spinner"></span> Sending verification email...';
      statusDiv.classList.remove('hidden');

      try {
        const response = await fetch(`${FUNCTIONS_URL}/resendVerificationEmail`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail })
        });

        const result = await response.json();

        if (response.ok) {
          statusDiv.className = 'status-message status-success';
          statusDiv.textContent = '‚úÖ Verification email sent! Check your inbox.';
          startCooldown(60);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        statusDiv.className = 'status-message status-error';
        statusDiv.textContent = error.message || 'Failed to send email. Please try again.';
        btn.disabled = false;
      }
    }

    function startCooldown(seconds) {
      resendCooldown = seconds;
      const btn = document.getElementById('resend-btn');
      const update = () => {
        if (resendCooldown > 0) {
          btn.textContent = `Resend (${resendCooldown}s)`;
          resendCooldown--;
          setTimeout(update, 1000);
        } else {
          btn.textContent = 'Resend Email';
          btn.disabled = false;
        }
      };
      update();
    }

    function showSuccess() {
      clearInterval(pollInterval);
      document.getElementById('pending-state').classList.add('hidden');
      document.getElementById('error-state').classList.add('hidden');
      document.getElementById('success-state').classList.remove('hidden');
      sessionStorage.removeItem('pendingVerification');
    }

    function showError(message) {
      document.getElementById('pending-state').classList.add('hidden');
      document.getElementById('success-state').classList.add('hidden');
      document.getElementById('error-state').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
